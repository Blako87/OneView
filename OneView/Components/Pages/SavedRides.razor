@page "/rides"
@using OneView.Services
@using OneView.Models
@using OneView.Components.Layout
@implements IDisposable

<PageTitle>Rides</PageTitle>

<div class="rides-container">
    <!-- Top Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-spacer"></div>
        <button class="nav-btn menu-btn" @onclick="ToggleNavMenu">
            <span class="menu-icon"><span></span><span></span><span></span></span> <!-- replaced unicode menu with CSS bars -->
        </button>
    </div>

    <!-- Ride Control & Live Data Panel -->
    <div class="widget-container">
        <!-- Ride Status Widget -->
        <div class="widget">
            <div class="widget-glow"></div>
            <div class="widget-content">
                <div class="status-display">
                    <div class="status-icon @(isRideActive ? "active" : "")"></div>
                    <div class="status-text">@(isRideActive ? "SESSION ACTIVE" : "SESSION INACTIVE")</div>
                </div>
            </div>
            <div class="widget-label">RIDE STATUS</div>
        </div>

        <!-- Controls Widget -->
        <div class="widget">
            <div class="widget-glow"></div>
            <div class="widget-content">
                <div class="action-buttons">
                    @if (!isRideActive)
                    {
                        <button class="action-btn start" @onclick="StartRide">
                            <span class="icon-circle green"></span> <!-- replaced unsupported emoji with styled circle -->
                            <span>START RIDE</span>
                        </button>
                    }
                    else
                    {
                        <button class="action-btn stop" @onclick="StopRide">
                            <span class="icon-square red"></span>
                            <span>STOP & SAVE</span>
                        </button>
                    }
                </div>
            </div>
            <div class="widget-label">CONTROLS</div>
        </div>

        <!-- Live Data Widget (only when ride is active) -->
        @if (isRideActive)
        {
            <div class="widget live-data-widget">
                <div class="widget-glow"></div>
                <div class="widget-content">
                    <div class="live-metrics">
                        <div class="live-metric-item">
                            <div class="live-metric-value">@liveDistance</div>
                            <div class="live-metric-label">DISTANCE (KM)</div>
                        </div>
                        <div class="live-metric-item">
                            <div class="live-metric-value">@liveDuration</div>
                            <div class="live-metric-label">DURATION</div>
                        </div>
                        <div class="live-metric-item">
                            <div class="live-metric-value">@liveAvgSpeed</div>
                            <div class="live-metric-label">AVG SPEED</div>
                        </div>
                    </div>
                </div>
                <div class="widget-label">LIVE METRICS</div>
            </div>
        }
    </div>

    <!-- Ride History -->
    <div class="history-section">
        <h2 class="section-title">RIDE HISTORY</h2>
        @if (!hasRides)
        {
            <div class="widget empty-state">
                <div class="widget-glow"></div>
                <div class="widget-content">
                    <div class="empty-icon">??</div>
                    <div class="empty-text">No saved rides yet.</div>
                </div>
                <div class="widget-label">HISTORY</div>
            </div>
        }
        else
        {
            <div class="history-list">
                @foreach (var ride in rides)
                {
                    <div class="history-item">
                        <div class="item-icon">??</div>
                        <div class="item-details">
                            <div class="item-title">@ride.DisplayDate</div>
                            <div class="item-subtitle">
                                @ride.DisplayDistance / @ride.DisplayDuration / @ride.DisplayAvgSpeed
                            </div>
                        </div>
                        <div class="item-arrow">?</div>
                    </div>
                }
            </div>
            <div class="danger-zone">
                <button class="btn-clear" @onclick="ClearAllRides">
                    <span class="icon-circle red"></span> <!-- replaced unsupported emoji with styled red circle -->
                    CLEAR ALL RIDES
                </button>
            </div>
        }
    </div>
</div>

@code {
    private List<RideHistoryItem> rides = new();
    private bool hasRides = false;
    private bool isRideActive = false;
    private System.Timers.Timer? rideTimer;

    // Live data fields
    private string liveDistance = "0.00";
    private string liveDuration = "00:00:00";
    private string liveAvgSpeed = "0.0";

    [CascadingParameter]
    public MainLayout? Layout { get; set; }

    protected override void OnInitialized()
    {
        LoadRides();
        isRideActive = App.ProfileService?.IsRideActive ?? false;

        if (isRideActive)
        {
            StartRideTimer();
        }
    }

    private void ToggleNavMenu()
    {
        Layout?.ToggleNavMenu();
    }

    private void LoadRides()
    {
        try
        {
            rides.Clear();
            var profile = App.ProfileService.LoadRideData();

            if (profile != null && profile.Distance > 0)
            {
                var rideItem = new RideHistoryItem
                {
                    Date = profile.LastTime,
                    Distance = profile.Distance,
                    Duration = profile.TimeOnBike,
                    AverageSpeed = profile.MediumSpeed
                };
                rides.Add(rideItem);
            }

            hasRides = rides.Count > 0;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading rides: {ex.Message}");
        }
    }

    private void StartRide()
    {
        App.ProfileService?.StartRide();
        isRideActive = true;
        StartRideTimer();
        StateHasChanged();
    }

    private void StopRide()
    {
        App.ProfileService?.StopRide();
        isRideActive = false;
        StopRideTimer();
        LoadRides();
        StateHasChanged();
    }

    private void StartRideTimer()
    {
        rideTimer = new System.Timers.Timer(1000);
        rideTimer.Elapsed += async (sender, e) => await UpdateLiveStats();
        rideTimer.Start();
    }

    private async Task UpdateLiveStats()
    {
        await InvokeAsync(() =>
        {
            var profile = App.ProfileService?.CurrentRideProfile;
            if (profile != null)
            {
                liveDistance = profile.Distance.ToString("F2");
                liveDuration = profile.TimeOnBike.ToString(@"hh\:mm\:ss");
                liveAvgSpeed = profile.MediumSpeed.ToString("F1");
            }
            StateHasChanged();
        });
    }

    private void StopRideTimer()
    {
        rideTimer?.Stop();
        rideTimer?.Dispose();
        rideTimer = null;
    }

    private async Task ClearAllRides()
    {
        App.ProfileService?.ClearRideData();
        var saveService = new Services.SaveprofileData();
        saveService.ClearAllData();
        LoadRides();
        System.Diagnostics.Debug.WriteLine("All rides cleared");
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        StopRideTimer();
    }

    public class RideHistoryItem
    {
        public DateTime Date { get; set; }
        public double Distance { get; set; }
        public TimeSpan Duration { get; set; }
        public double AverageSpeed { get; set; }

        public string DisplayDate => Date.ToString("MM/dd/yyyy HH:mm");
        public string DisplayDistance => $"{Distance:F2} km";
        public string DisplayDuration => Duration.ToString(@"hh\:mm\:ss");
        public string DisplayAvgSpeed => $"{AverageSpeed:F1} km/h";
    }
}

<style>
    /* Added new icon styles */
    .menu-icon { display:flex; flex-direction:column; gap:4px; }
    .menu-icon span { display:block; width:20px; height:2px; background:#00d4ff; box-shadow:0 0 6px rgba(0,212,255,0.7); border-radius:2px; }
    .nav-btn:hover .menu-icon span { background:#00ff88; box-shadow:0 0 8px rgba(0,255,136,0.7); }

    .icon-circle { display:inline-block; width:16px; height:16px; border-radius:50%; }
    .icon-square { display:inline-block; width:16px; height:16px; }
    .icon-circle.green { background:#00ff88; box-shadow:0 0 8px rgba(0,255,136,0.7); }
    .icon-circle.red { background:#ff4444; box-shadow:0 0 8px rgba(255,68,68,0.7); }
    .icon-square.red { background:#ff4444; box-shadow:0 0 8px rgba(255,68,68,0.7); }

    /* existing styles remain below */
    .rides-container { min-height:100vh; background:#0a0e27; padding:16px; font-family:'Segoe UI', -apple-system, sans-serif; }
    .nav-bar { display:flex; justify-content:flex-end; padding:12px 8px; margin-bottom:20px; }
    .nav-btn { width:42px; height:42px; background:rgba(0,212,255,0.08); border:1px solid rgba(0,212,255,0.25); border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1.4rem; color:#00d4ff; }
    .widget-container { display:grid; grid-template-columns:repeat(2,1fr); gap:14px; max-width:480px; margin:0 auto 28px; }
    .widget { position:relative; background:rgba(10,20,40,0.5); backdrop-filter:blur(16px); border:1px solid rgba(0,212,255,0.25); border-radius:16px; padding:18px; aspect-ratio:1; overflow:hidden; }
    .widget-glow { position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:radial-gradient(circle, rgba(0,212,255,0.08) 0%, transparent 70%); animation:rotate-glow 20s linear infinite; }
    .widget-content { position:relative; width:100%; height:calc(100% - 30px); display:flex; align-items:center; justify-content:center; }
    .widget-label { position:absolute; bottom:12px; left:16px; right:16px; font-size:0.65rem; color:rgba(0,212,255,0.85); text-transform:uppercase; letter-spacing:1.2px; font-weight:700; text-align:center; }
    .status-display { display:flex; flex-direction:column; align-items:center; gap:12px; }
    .status-icon { width:40px; height:40px; border-radius:50%; background:rgba(255,68,68,0.2); border:2px solid rgba(255,68,68,0.4); transition:all 0.3s ease; }
    .status-icon.active { background:rgba(0,255,136,0.2); border-color:rgba(0,255,136,0.5); box-shadow:0 0 15px rgba(0,255,136,0.5); animation:pulse-icon 2s ease-in-out infinite; }
    .status-text { font-size:0.8rem; font-weight:700; color:#fff; letter-spacing:1px; }
    .action-buttons { display:flex; flex-direction:column; gap:12px; width:100%; }
    .action-btn { padding:12px; border-radius:10px; border:1px solid; font-size:0.8rem; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }
    .action-btn.start { background:rgba(0,255,136,0.15); border-color:rgba(0,255,136,0.5); color:#00ff88; }
    .action-btn.stop { background:rgba(255,68,68,0.15); border-color:rgba(255,68,68,0.5); color:#ff4444; }
    .live-data-widget { grid-column:span 2; aspect-ratio:auto; }
    .live-metrics { display:flex; justify-content:space-around; width:100%; text-align:center; }
    .live-metric-value { font-size:1.4rem; font-weight:700; color:#00ff88; font-family:'Courier New', monospace; }
    .live-metric-label { font-size:0.6rem; color:rgba(255,255,255,0.6); text-transform:uppercase; margin-top:4px; }
    .history-section { max-width:480px; margin:0 auto; }
    .section-title { font-size:1rem; color:rgba(0,212,255,0.85); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:14px; padding-left:8px; }
    .empty-state .empty-icon { font-size:3rem; opacity:0.5; }
    .empty-state .empty-text { margin-top:12px; font-size:0.9rem; color:rgba(255,255,255,0.6); }
    .history-list { display:flex; flex-direction:column; gap:10px; }
    .history-item { display:flex; align-items:center; gap:14px; padding:12px; background:rgba(10,20,40,0.5); border:1px solid rgba(0,212,255,0.2); border-radius:10px; }
    .item-icon { font-size:1.5rem; color:#00d4ff; }
    .item-details { flex:1; }
    .item-title { font-size:0.8rem; font-weight:600; color:#fff; }
    .item-subtitle { font-size:0.7rem; color:rgba(255,255,255,0.6); }
    .item-arrow { font-size:1.2rem; color:rgba(0,212,255,0.5); }
    .danger-zone { margin-top:28px; text-align:center; }
    .btn-clear { background:transparent; border:1px solid rgba(255,68,68,0.4); color:rgba(255,68,68,0.7); padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; display:inline-flex; align-items:center; gap:8px; }
    @@keyframes pulse-icon { 0%,100% { transform:scale(1);} 50% { transform:scale(1.08);} }
    @@keyframes rotate-glow { from { transform:rotate(0deg);} to { transform:rotate(360deg);} }
</style>
