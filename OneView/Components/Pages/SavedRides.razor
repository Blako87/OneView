@page "/rides"
@using OneView.ViewModels
@using OneView.Components.Layout
@implements IDisposable

<PageTitle>Rides</PageTitle>

<div class="rides-container">
    <!-- Top Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-spacer"></div>
        <button class="nav-btn menu-btn" @onclick="ToggleNavMenu">
            <span class="menu-icon"><span></span><span></span><span></span></span>
        </button>
    </div>

    <!-- Ride Control & Live Data Panel -->
    <div class="widget-container">
        <!-- Ride Status Widget -->
        <div class="widget">
            <div class="widget-glow"></div>
            <div class="widget-content">
                <div class="status-display">
                    <div class="status-icon @(_viewModel.IsRideActive ? "active" : "")"></div>
                    <div class="status-text">@(_viewModel.IsRideActive ? "SESSION ACTIVE" : "SESSION INACTIVE")</div>
                </div>
            </div>
            <div class="widget-label">RIDE STATUS</div>
        </div>

        <!-- Controls Widget -->
        <div class="widget">
            <div class="widget-glow"></div>
            <div class="widget-content">
                <div class="action-buttons">
                    @if (!_viewModel.IsRideActive)
                    {
                        <button class="action-btn start" @onclick="_viewModel.StartRideCommand.Execute">
                            <span class="icon-circle green"></span>
                            <span>START RIDE</span>
                        </button>
                    }
                    else
                    {
                        <button class="action-btn stop" @onclick="_viewModel.StopRideCommand.Execute">
                            <span class="icon-square red"></span>
                            <span>STOP & SAVE</span>
                        </button>
                    }
                </div>
            </div>
            <div class="widget-label">CONTROLS</div>
        </div>

        <!-- Live Data Widget (only when ride is active) -->
        @if (_viewModel.IsRideActive)
        {
            <div class="widget live-data-widget">
                <div class="widget-glow"></div>
                <div class="widget-content">
                    <div class="live-metrics">
                        <div class="live-metric-item">
                            <div class="live-metric-value">@_viewModel.LiveDistance</div>
                            <div class="live-metric-label">DISTANCE (KM)</div>
                        </div>
                        <div class="live-metric-item">
                            <div class="live-metric-value">@_viewModel.LiveDuration</div>
                            <div class="live-metric-label">DURATION</div>
                        </div>
                        <div class="live-metric-item">
                            <div class="live-metric-value">@_viewModel.LiveAvgSpeed</div>
                            <div class="live-metric-label">AVG SPEED</div>
                        </div>
                    </div>
                    <div class="live-incline">
                        <div class="incline-group">
                            <div class="incline-label">LEFT TILT</div>
                            <div class="incline-range">@_viewModel.LiveMinInclineLeft° — @_viewModel.LiveMaxInclineLeft°</div>
                        </div>
                        <div class="incline-group">
                            <div class="incline-label">RIGHT TILT</div>
                            <div class="incline-range">@_viewModel.LiveMinInclineRight° — @_viewModel.LiveMaxInclineRight°</div>
                        </div>
                    </div>
                </div>
                <div class="widget-label">LIVE METRICS</div>
            </div>
        }
    </div>

    <!-- Ride History -->
    <div class="history-section">
        <h2 class="section-title">RIDE HISTORY</h2>
        @if (!_viewModel.HasRides)
        {
            <div class="widget empty-state">
                <div class="widget-glow"></div>
                <div class="widget-content">
                    <div class="empty-icon">??</div>
                    <div class="empty-text">No saved rides yet.</div>
                </div>
                <div class="widget-label">HISTORY</div>
            </div>
        }
        else
        {
            <div class="history-list">
                @foreach (var ride in _viewModel.Rides)
                {
                    <div class="history-item @(_viewModel.ExpandedRideId == ride.Id ? "expanded" : "")" 
                         @onclick="() => _viewModel.ToggleRideDetailsCommand.Execute(ride)">
                        <div class="history-item-header">
                            <div class="item-icon">??</div>
                            <div class="item-details">
                                <div class="item-title">@ride.DisplayDate</div>
                                <div class="item-subtitle">
                                    @ride.DisplayDistance • @ride.DisplayDuration • @ride.DisplayAvgSpeed
                                </div>
                            </div>
                            <div class="item-arrow @(_viewModel.ExpandedRideId == ride.Id ? "rotated" : "")">?</div>
                        </div>
                        
                        @if (_viewModel.ExpandedRideId == ride.Id)
                        {
                            <div class="history-item-details">
                                <div class="detail-section">
                                    <div class="detail-title">SPEED STATS</div>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <div class="detail-label">Average</div>
                                            <div class="detail-value">@ride.AverageSpeed.ToString("F1") km/h</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Maximum</div>
                                            <div class="detail-value">@ride.MaxSpeed.ToString("F1") km/h</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-title">INCLINE ANGLES</div>
                                    <div class="detail-grid">
                                        <div class="detail-item incline-left">
                                            <div class="detail-label">Left Tilt Range</div>
                                            <div class="detail-value">@ride.MinInclineLeft.ToString("F1")° — @ride.MaxInclineLeft.ToString("F1")°</div>
                                        </div>
                                        <div class="detail-item incline-right">
                                            <div class="detail-label">Right Tilt Range</div>
                                            <div class="detail-value">@ride.MinInclineRight.ToString("F1")° — @ride.MaxInclineRight.ToString("F1")°</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <div class="detail-title">RIDE INFO</div>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <div class="detail-label">Distance</div>
                                            <div class="detail-value">@ride.Distance.ToString("F2") km</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Duration</div>
                                            <div class="detail-value">@ride.Duration.ToString(@"hh\:mm\:ss")</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="danger-zone">
                <button class="btn-clear" @onclick="_viewModel.ClearAllRidesCommand.ExecuteAsync">
                    <span class="icon-circle red"></span>
                    CLEAR ALL RIDES
                </button>
            </div>
        }
    </div>
</div>

@code {
    private SavedRidesViewModel _viewModel = new();

    [CascadingParameter]
    public MainLayout? Layout { get; set; }

    protected override void OnInitialized()
    {
        // Subscribe to property changes for UI updates
        // InvokeAsync ensures StateHasChanged runs on UI thread
        _viewModel.PropertyChanged += async (s, e) =>
        {
            await InvokeAsync(StateHasChanged);
        };
    }

    private void ToggleNavMenu()
    {
        Layout?.ToggleNavMenu();
    }

    public void Dispose()
    {
        _viewModel?.Dispose();
    }
}

<style>
    /* Menu icon styles */
    .menu-icon { display:flex; flex-direction:column; gap:4px; }
    .menu-icon span { display:block; width:20px; height:2px; background:#00d4ff; box-shadow:0 0 6px rgba(0,212,255,0.7); border-radius:2px; }
    .nav-btn:hover .menu-icon span { background:#00ff88; box-shadow:0 0 8px rgba(0,255,136,0.7); }

    .icon-circle { display:inline-block; width:16px; height:16px; border-radius:50%; }
    .icon-square { display:inline-block; width:16px; height:16px; }
    .icon-circle.green { background:#00ff88; box-shadow:0 0 8px rgba(0,255,136,0.7); }
    .icon-circle.red { background:#ff4444; box-shadow:0 0 8px rgba(255,68,68,0.7); }
    .icon-square.red { background:#ff4444; box-shadow:0 0 8px rgba(255,68,68,0.7); }

    /* Base styles */
    .rides-container { min-height:100vh; background:#0a0e27; padding:16px; font-family:'Segoe UI', -apple-system, sans-serif; }
    .nav-bar { display:flex; justify-content:flex-end; padding:12px 8px; margin-bottom:20px; }
    .nav-btn { width:42px; height:42px; background:rgba(0,212,255,0.08); border:1px solid rgba(0,212,255,0.25); border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1.4rem; color:#00d4ff; transition:all 0.2s ease; }
    .nav-btn:hover { background:rgba(0,255,136,0.12); border-color:rgba(0,255,136,0.4); }
    
    .widget-container { display:grid; grid-template-columns:repeat(2,1fr); gap:14px; max-width:480px; margin:0 auto 28px; }
    .widget { position:relative; background:rgba(10,20,40,0.5); backdrop-filter:blur(16px); border:1px solid rgba(0,212,255,0.25); border-radius:16px; padding:18px; aspect-ratio:1; overflow:hidden; }
    .widget-glow { position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:radial-gradient(circle, rgba(0,212,255,0.08) 0%, transparent 70%); animation:rotate-glow 20s linear infinite; }
    .widget-content { position:relative; width:100%; height:calc(100% - 30px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; }
    .widget-label { position:absolute; bottom:12px; left:16px; right:16px; font-size:0.65rem; color:rgba(0,212,255,0.85); text-transform:uppercase; letter-spacing:1.2px; font-weight:700; text-align:center; }
    
    .status-display { display:flex; flex-direction:column; align-items:center; gap:12px; }
    .status-icon { width:40px; height:40px; border-radius:50%; background:rgba(255,68,68,0.2); border:2px solid rgba(255,68,68,0.4); transition:all 0.3s ease; }
    .status-icon.active { background:rgba(0,255,136,0.2); border-color:rgba(0,255,136,0.5); box-shadow:0 0 15px rgba(0,255,136,0.5); animation:pulse-icon 2s ease-in-out infinite; }
    .status-text { font-size:0.8rem; font-weight:700; color:#fff; letter-spacing:1px; text-align:center; }
    
    .action-buttons { display:flex; flex-direction:column; gap:12px; width:100%; }
    .action-btn { padding:12px; border-radius:10px; border:1px solid; font-size:0.8rem; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s ease; }
    .action-btn.start { background:rgba(0,255,136,0.15); border-color:rgba(0,255,136,0.5); color:#00ff88; }
    .action-btn.start:hover { background:rgba(0,255,136,0.25); box-shadow:0 0 15px rgba(0,255,136,0.3); }
    .action-btn.stop { background:rgba(255,68,68,0.15); border-color:rgba(255,68,68,0.5); color:#ff4444; }
    .action-btn.stop:hover { background:rgba(255,68,68,0.25); box-shadow:0 0 15px rgba(255,68,68,0.3); }
    
    .live-data-widget { grid-column:span 2; aspect-ratio:auto; }
    .live-metrics { display:flex; justify-content:space-around; width:100%; text-align:center; }
    .live-metric-value { font-size:1.4rem; font-weight:700; color:#00ff88; font-family:'Courier New', monospace; }
    .live-metric-label { font-size:0.6rem; color:rgba(255,255,255,0.6); text-transform:uppercase; margin-top:4px; letter-spacing:0.8px; }
    
    .live-incline { display:flex; justify-content:space-around; width:100%; margin-top:16px; padding-top:16px; border-top:1px solid rgba(0,212,255,0.2); }
    .incline-group { text-align:center; }
    .incline-label { font-size:0.6rem; color:rgba(0,212,255,0.7); text-transform:uppercase; margin-bottom:6px; letter-spacing:0.8px; }
    .incline-range { font-size:0.9rem; font-weight:700; color:#00d4ff; font-family:'Courier New', monospace; }
    
    .history-section { max-width:480px; margin:0 auto; }
    .section-title { font-size:1rem; color:rgba(0,212,255,0.85); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:14px; padding-left:8px; font-weight:700; }
    
    .empty-state .empty-icon { font-size:3rem; opacity:0.5; }
    .empty-state .empty-text { margin-top:12px; font-size:0.9rem; color:rgba(255,255,255,0.6); }
    
    .history-list { display:flex; flex-direction:column; gap:10px; }
    .history-item { background:rgba(10,20,40,0.5); border:1px solid rgba(0,212,255,0.2); border-radius:10px; cursor:pointer; transition:all 0.2s ease; overflow:hidden; }
    .history-item:hover { border-color:rgba(0,212,255,0.4); background:rgba(10,20,40,0.7); }
    .history-item.expanded { border-color:rgba(0,255,136,0.4); }
    
    .history-item-header { display:flex; align-items:center; gap:14px; padding:12px; }
    .item-icon { font-size:1.5rem; }
    .item-details { flex:1; }
    .item-title { font-size:0.8rem; font-weight:600; color:#fff; margin-bottom:4px; }
    .item-subtitle { font-size:0.7rem; color:rgba(255,255,255,0.6); }
    .item-arrow { font-size:0.8rem; color:rgba(0,212,255,0.5); transition:transform 0.3s ease; }
    .item-arrow.rotated { transform:rotate(180deg); }
    
    .history-item-details { padding:0 12px 16px 12px; border-top:1px solid rgba(0,212,255,0.1); animation:expand-details 0.3s ease; }
    .detail-section { margin-top:16px; }
    .detail-title { font-size:0.65rem; color:rgba(0,212,255,0.85); text-transform:uppercase; letter-spacing:1.2px; font-weight:700; margin-bottom:10px; }
    .detail-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .detail-item { background:rgba(0,212,255,0.05); border:1px solid rgba(0,212,255,0.15); border-radius:8px; padding:10px; }
    .detail-item.incline-left { border-color:rgba(255,136,0,0.3); background:rgba(255,136,0,0.05); }
    .detail-item.incline-right { border-color:rgba(136,0,255,0.3); background:rgba(136,0,255,0.05); }
    .detail-label { font-size:0.65rem; color:rgba(255,255,255,0.6); text-transform:uppercase; margin-bottom:4px; letter-spacing:0.8px; }
    .detail-value { font-size:0.9rem; font-weight:700; color:#00ff88; font-family:'Courier New', monospace; }
    
    .danger-zone { margin-top:28px; text-align:center; padding-top:28px; border-top:1px solid rgba(255,68,68,0.2); }
    .btn-clear { background:transparent; border:1px solid rgba(255,68,68,0.4); color:rgba(255,68,68,0.7); padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; display:inline-flex; align-items:center; gap:8px; transition:all 0.2s ease; text-transform:uppercase; letter-spacing:1px; }
    .btn-clear:hover { background:rgba(255,68,68,0.15); border-color:rgba(255,68,68,0.6); color:#ff4444; }
    
    @@keyframes pulse-icon { 0%,100% { transform:scale(1);} 50% { transform:scale(1.08);} }
    @@keyframes rotate-glow { from { transform:rotate(0deg);} to { transform:rotate(360deg);} }
    @@keyframes expand-details { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
</style>
